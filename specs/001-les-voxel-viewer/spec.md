# Feature Specification: leSボクセルビューアー

このドキュメントは日本語で記載すること。

**Feature Branch**: `001-les-voxel-viewer`  
**Created**: 2026-02-12  
**Status**: Draft  
**Input**: User description: "平文形式のボクセルデータを読み込み、VSCode内でレンダリングする拡張機能を作成したい。ファイルツリーで *.leS を直接開く、*.leS ファイルを開いたエディタからビュアーを開く、コマンドパレットでビュアーを開きleSファイルをドラッグ・アンド・ドロップ、の方法でビュアーを開きたい。tmp/ にシェーダーとreact実装があり、最大 1000x1000x1000 程度のボクセルを想定。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ファイルツリーから直接開く (Priority: P1)

ユーザーはファイルツリー上の .leS ファイルを直接開いて、すぐに3Dビューアーで内容を確認したい。

**Why this priority**: もっとも一般的で最短の導線であり、最小の価値を提供できるため。

**Independent Test**: ファイルツリーから .leS を開き、ビューアーが起動して内容が描画されることを確認する。

**Acceptance Scenarios**:

1. **Given** .leS ファイルがワークスペースに存在する, **When** ユーザーがファイルツリーで .leS を開く, **Then** ビューアーが起動しボクセルが描画される
2. **Given** .leS ファイルが破損している, **When** ユーザーがファイルツリーで開く, **Then** 読み込みエラーが分かりやすく表示される

---

### User Story 2 - エディタからビューアーを開く (Priority: P2)

ユーザーは .leS をテキストで開いた状態から、コマンドでビューアーに切り替えたい。

**Why this priority**: 既存のテキスト確認フローを崩さずに視覚化できるため。

**Independent Test**: .leS をテキストエディタで開いた後にコマンドを実行し、同じファイルがビューアーで表示されることを確認する。

**Acceptance Scenarios**:

1. **Given** .leS をテキストエディタで開いている, **When** 「Voxel Viewerを開く」コマンドを実行する, **Then** 同じファイルがビューアーで開かれる

---

### User Story 3 - コマンドパレットとドラッグ・アンド・ドロップで開く (Priority: P3)

ユーザーはコマンドパレットから空のビューアーを開き、ファイルをドラッグ・アンド・ドロップして表示したい。

**Why this priority**: 複数ファイルの比較や、ファイルツリーを使わない作業にも対応できるため。

**Independent Test**: コマンドパレットからビューアーを開き、.leS をドロップして表示できることを確認する。

**Acceptance Scenarios**:

1. **Given** ビューアーが空の状態で開いている, **When** .leS ファイルをドロップする, **Then** その内容が描画される

---

### Edge Cases

- ヘッダのサイズ指定と実データ数が一致しない場合はどうするか
- .leS のサイズが上限を超える場合の扱い
- 値が許容範囲外（例: 負値や大きすぎる値）の場合
- ボクセルが全て空（値が0）の場合
- 低性能環境で描画負荷が高い場合
- 描画環境が利用できない場合

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは .leS ファイルを既定でカスタムビューアーに関連付けし、ファイルツリーから直接ビューアーを開けること
- **FR-010**: ユーザーが必要に応じてテキストで開ける導線（再度開く）を提供すること
- **FR-002**: システムは .leS をテキストで開いた状態からビューアーを開くコマンドを提供すること
- **FR-003**: システムはコマンドパレットから空のビューアーを起動できること
- **FR-004**: ビューアーは .leS ファイルのドラッグ・アンド・ドロップで表示を更新できること
- **FR-005**: システムは .leS ヘッダを読み取り、ボクセル配列のサイズと整合性を検証すること
- **FR-006**: システムは値0を空ボクセルとして扱うこと
- **FR-007**: システムは値1-255を1-16の循環で色インデックスへマッピングして表示すること
- **FR-008**: システムはサイズ上限（最大 1000x1000x1000）を超える場合、ユーザーに明示的なエラーを表示すること
- **FR-009**: システムは読み込み失敗時に原因が分かるメッセージを表示すること
- **FR-011**: システムはデータ行数がX*Y、各行の値数がZであることを検証すること
- **FR-012**: システムは行インデックスを row i -> (x=i//Y, y=i%Y) としてZ方向の値を読み込むこと
- **FR-013**: システムは .leS.gz を次フェーズ対応とし、初期は未対応であることを明示する
- **FR-014**: voxel_length は表示スケールに反映せず、格子サイズのみで表示すること

### Non-Functional Requirements *(mandatory)*

- **NFR-001**: 200x200x200程度のデータは、標準的な開発用PCで初回描画が5秒以内であること
- **NFR-002**: 標準的な操作（回転・ズーム）において、体感で滑らかな操作性を維持すること
- **NFR-003**: 最大サイズのデータは、読み込み時に進捗または待機表示を提供すること
- **NFR-004**: 表示や操作の文言は既存の拡張機能内で統一されること
- **NFR-005**: 仕様・設計・運用・ユーザー向け文書は日本語で更新されること

### Key Entities *(include if feature involves data)*

- **VoxelDataset**: .leS から読み込んだボクセルデータ全体（寸法、ボクセル値配列、ボクセル間隔）
- **VoxelGrid**: 描画対象となる3次元格子（サイズ、原点、座標系）
- **PaletteMapping**: ボクセル値と表示色の対応表（0=空、1-255は1-16の循環で色）
- **ViewerSession**: ビューアーの表示状態（現在ファイル、表示設定、カメラ状態）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ファイルツリーから .leS を開いたとき、95%のケースで5秒以内に初回描画が完了する
- **SC-002**: 200x200x200データの操作で、90%のユーザーが「滑らか」と評価する
- **SC-003**: 破損ファイルの読み込み時に、原因が分かるエラー表示が100%提示される
- **SC-004**: 3つの導線（ファイルツリー、エディタ、ドラッグ・アンド・ドロップ）すべてで表示成功率が95%以上である

## Assumptions

- .leS の先頭行は「X Y Z」または「X Y Z voxelLength」の3-4つの数値で構成される
- 2行目以降は空白区切りのボクセル値が並び、行数は X * Y、各行の値数は Z と一致する
- ボクセル値は uint8 の範囲で、0は空、1-255は1-16の循環で色分け対象である
- データは (X, Y, Z) の順で並び、転置処理は不要である

## Clarifications

### Session 2026-02-12

- Q: ボクセル値の範囲とマッピングは? → A: uint8で、1-255を1-16の循環にマッピングする
- Q: .leS の既定の開き方は? → A: 既定でカスタムビューアーで開く
- Q: .leS の行順と配列対応は? → A: row i -> (x=i//Y, y=i%Y) でZ方向を並べる
- Q: .leS.gz を初期で対応するか? → A: 次フェーズで対応し、初期は未対応を明示する
- Q: voxel_length をスケールに反映するか? → A: 反映せず、格子サイズのみで表示する
